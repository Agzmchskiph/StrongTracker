<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StrongTracker ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è + –±—Ä—É—Å—å—è</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#151a21" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/512.png">

<style>
  :root{ --bg:#0f1216; --panel:#151a21; --muted:#9aa4b2; --text:#eef2f7; --accent:#6aa6ff;
         --ok:#39d98a; --warn:#ffd166; --chip:#1b222c; --border:#2a3340; --input:#0f1216; }
  .light{ --bg:#f6f8fb; --panel:#ffffff; --muted:#5c6672; --text:#1e242b; --accent:#2d6cdf;
          --ok:#23ad6b; --warn:#b8860b; --chip:#f1f5fb; --border:#dfe7f3; --input:#ffffff; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(0deg,var(--bg),var(--panel));border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px} .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  h1{margin:0 12px 0 0;font-size:20px}
  .chip{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--chip);color:var(--muted);display:inline-flex;gap:8px;align-items:center}
  .spacer{flex:1}
  button,input[type="date"]{height:38px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--input);color:var(--text)}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)} button.ghost{background:transparent}
  main{max-width:1100px;margin:16px auto;padding:0 16px 24px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px} @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 4px 20px rgba(0,0,0,.12)}
  .card h2{margin:0 0 12px;font-size:18px} .sub{color:var(--muted);font-size:13px}
  .weekbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .wbtn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--chip);color:var(--muted);cursor:pointer}
  .wbtn.active{border-color:var(--accent);color:var(--text)}
  .plan-row{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px 12px;border:1px dashed var(--border);border-radius:12px;margin:8px 0;background:rgba(0,0,0,.04)}
  .sets{display:flex;gap:8px;flex-wrap:wrap}
  .set{display:flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);border-radius:10px;padding:6px 8px}
  .tag{font-size:12px;color:var(--muted);padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:var(--chip)}
  .set input{width:70px;text-align:center;border:1px solid var(--border);border-radius:8px;padding:6px;background:var(--input);color:var(--text)}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left} th{background:var(--chip);color:var(--muted);font-weight:600}
  .tabs{display:flex;gap:8px;margin-top:8px} .hidden{display:none}
  canvas{width:100%;height:300px;background:var(--chip);border:1px solid var(--border);border-radius:12px}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:12px}
  /* –ú–æ–¥–∞–ª–∫–∞ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px}
  .modal .box{max-width:520px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .modal h3{margin:0 0 10px} .modal .row{margin-top:8px}
  .modal input{width:100%}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>StrongTracker</h1>
      <span id="todayChip" class="chip">–°–µ–≥–æ–¥–Ω—è: ‚Äî</span>
      <span id="wkChip" class="chip">–ù–µ–¥–µ–ª—è —Ü–∏–∫–ª–∞: ‚Äî</span>
      <span id="dayChip" class="chip">–î–µ–Ω—å: ‚Äî</span>
      <div class="spacer"></div>
      <label class="chip">–°—Ç–∞—Ä—Ç —Ü–∏–∫–ª–∞: <input type="date" id="startDateInput"></label>
      <button id="prevDay" class="ghost" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">‚óÄ</button>
      <button id="nextDay" class="ghost" title="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">‚ñ∂</button>
      <button id="retake" class="ghost" title="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã/—Ä–µ—Ç–µ—Å—Ç">‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
      <button id="toggleTheme" class="ghost" title="–°–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞">üåì</button>
      <button id="resetAll" class="ghost" title="–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">‚ôª –°–±—Ä–æ—Å</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–ª–∞–Ω <span id="planTitle" class="sub"></span></h2>
      <div id="weekbar" class="weekbar"></div>
      <div id="planBox"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button id="saveBtn" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
        <button id="completeBtn">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ</button>
        <span id="saveStatus" class="sub"></span>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>–ò—Å—Ç–æ—Ä–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</h2>
        <div class="tabs">
          <button id="tabHistory" class="primary">–ò—Å—Ç–æ—Ä–∏—è</button>
          <button id="tabChart">–ì—Ä–∞—Ñ–∏–∫</button>
        </div>
      </div>
      <div id="historyView">
        <table>
          <thead><tr>
            <th>–î–∞—Ç–∞</th><th>–î–µ–Ω—å</th><th>–ù–µ–¥–µ–ª—è</th>
            <th>–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</th><th>–ë—Ä—É—Å—å—è</th><th>–ò—Ç–æ–≥</th>
          </tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <div id="chartView" class="hidden">
        <canvas id="chart" width="800" height="300"></canvas>
      </div>
    </section>
  </div>
</main>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤/—Ä–µ—Ç–µ—Å—Ç–∞ -->
<div id="wizard" class="modal hidden" role="dialog" aria-modal="true">
  <div class="box">
    <h3>–ó–∞–¥–∞—ë–º —Ç–µ–∫—É—â–∏–µ –º–∞–∫—Å–∏–º—É–º—ã</h3>
    <p class="sub">–í–≤–µ–¥–∏ <b>–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –∑–∞ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥</b> —Å–µ–π—á–∞—Å: –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –∏ –±—Ä—É—Å—å—è. –ú—ã –ø–æ—Å—Ç—Ä–æ–∏–º 4-–Ω–µ–¥–µ–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ–¥ —Ç–µ–±—è.</p>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:180px">
        <label class="sub">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è (–º–∞–∫—Å. –∑–∞ 1 –ø–æ–¥—Ö–æ–¥)</label>
        <input type="number" id="maxPull" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 15">
      </div>
      <div style="flex:1;min-width:180px">
        <label class="sub">–ë—Ä—É—Å—å—è (–º–∞–∫—Å. –∑–∞ 1 –ø–æ–¥—Ö–æ–¥)</label>
        <input type="number" id="maxDips" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 10">
      </div>
    </div>
    <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:12px">
      <button id="saveWizard" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</button>
      <button id="cancelWizard" class="ghost">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <p class="sub" id="wizardNote"></p>
  </div>
</div>

<script>
/* ===== –£—Ç–∏–ª–∏—Ç—ã –¥–∞—Ç—ã (–ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ UTC-—Å–¥–≤–∏–≥–∞) ===== */
const fmtDateKey = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const parseKey=(k)=>{const [y,m,d]=k.split('-').map(Number);return new Date(y,m-1,d);};
const isoDay=(d)=>{const w=d.getDay();return w===0?7:w;};
const addDays=(d,n)=>new Date(d.getFullYear(),d.getMonth(),d.getDate()+n);
const diffDays=(a,b)=>Math.round((parseKey(b)-parseKey(a))/(1000*60*60*24));
const mod=(n,m)=>((n%m)+m)%m;

/* ===== –•—Ä–∞–Ω–∏–ª–∏—â–µ ===== */
const store={
  get settings(){let s=JSON.parse(localStorage.getItem('st_settings')||'{}');
    if(!s.theme) s.theme='dark';
    if(!s.startDate) s.startDate=nextMonday();
    localStorage.setItem('st_settings',JSON.stringify(s)); return s;},
  set settings(v){localStorage.setItem('st_settings',JSON.stringify(v));},
  get workouts(){return JSON.parse(localStorage.getItem('st_workouts')||'{}');},
  set workouts(v){localStorage.setItem('st_workouts',JSON.stringify(v));}
};
function nextMonday(){ const t=new Date(), d=t.getDay(); const add = d===0?1:(8-d); const nd=add===8? t : addDays(t,add); return fmtDateKey(nd); }

/* ===== –ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞–∫—Å–∏–º—É–º–æ–≤ ===== */
function buildProgram(maxPull, maxDips){
  // –∑–∞—â–∏—Ç–∞ –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ
  maxPull = Math.max(3, Math.floor(maxPull));
  maxDips = Math.max(3, Math.floor(maxDips));

  // —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á—ë—Ç–∞ —Å–µ—Ç–æ–≤ (–æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ –º–∏–Ω–∏–º—É–º 1 –ø–æ–≤—Ç–æ—Ä–∞)
  const r = (x)=>Math.max(1, Math.round(x));

  // —Ç—è–∂—ë–ª—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è: 90/80/70/60% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
  const pullHeavy = [r(0.9*maxPull), r(0.8*maxPull), r(0.7*maxPull), r(0.6*maxPull)];
  // –ª—ë–≥–∫–∏–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è: 60‚Äì70% –ø–æ 5‚Äì6 –ø–æ–¥—Ö–æ–¥–æ–≤
  const pullLight = Array(6).fill(0).map(()=>[r(0.6*maxPull), r(0.7*maxPull)]);

  // —Ç—è–∂—ë–ª—ã–µ –±—Ä—É—Å—å—è: 90/80/70/60%
  const dipsHeavy = [r(0.9*maxDips), r(0.8*maxDips), r(0.7*maxDips), r(0.6*maxDips)];
  // –ª—ë–≥–∫–∏–µ –±—Ä—É—Å—å—è: 50‚Äì60% –ø–æ 5 –ø–æ–¥—Ö–æ–¥–æ–≤
  const dipsLight = Array(5).fill(0).map(()=>[r(0.5*maxDips), r(0.6*maxDips)]);

  // –ª–µ—Å—Ç–Ω–∏—Ü–∞ –Ω–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è: –ø–∏–∫ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
  const peak = Math.min(7, Math.max(4, Math.round(maxPull/3)+2)); // 4..7
  const ladder = [...Array(peak).keys()].map(i=>i+1).concat([...Array(peak-1).keys()].reverse().map(i=>i+1));

  return {
    1:{name:"–ü–Ω ‚Äî –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è (—Ç—è–∂—ë–ª—ã–π)", blocks:[
      {ex:"–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", type:"fixed", sets:pullHeavy, note:"–û—Ç–¥—ã—Ö 2‚Äì3 –º–∏–Ω"},
      {ex:"–ü–ª–∞–Ω–∫–∞", type:"time", sets:["40—Å","40—Å","40—Å"], note:""}
    ]},
    2:{name:"–í—Ç ‚Äî –ë—Ä—É—Å—å—è (–ª—ë–≥–∫–∏–π)", blocks:[
      {ex:"–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö", type:"range", sets:dipsLight, note:"–ú–µ–¥–ª–µ–Ω–Ω—ã–π —Ç–µ–º–ø"},
      {ex:"–†–∞—Å—Ç—è–∂–∫–∞", type:"note", note:"–ì—Ä—É–¥—å/–ø–ª–µ—á–∏ ‚Äî 5 –º–∏–Ω"}
    ]},
    3:{name:"–°—Ä ‚Äî –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è (–ª—ë–≥–∫–∏–π)", blocks:[
      {ex:"–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è (—Ä–∞–∑–Ω—ã–µ —Ö–≤–∞—Ç—ã)", type:"range", sets:pullLight, note:"–û—Ç–¥—ã—Ö ~90 —Å–µ–∫"},
      {ex:"–£–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ", type:"time", sets:["–º–∞–∫—Å","–º–∞–∫—Å"], note:""}
    ]},
    4:{name:"–ß—Ç ‚Äî –ë—Ä—É—Å—å—è (—Ç—è–∂—ë–ª—ã–π)", blocks:[
      {ex:"–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö", type:"fixed", sets:dipsHeavy, note:"–û—Ç–¥—ã—Ö 2 –º–∏–Ω"},
      {ex:"–ü–ª–∞–Ω–∫–∞", type:"time", sets:["40—Å","40—Å","40—Å"], note:""}
    ]},
    5:{name:"–ü—Ç ‚Äî –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è (–ª–µ—Å—Ç–Ω–∏—Ü–∞)", blocks:[
      {ex:"–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è ¬´–ª–µ—Å—Ç–Ω–∏—Ü–µ–π¬ª", type:"ladder", scheme:ladder, note:"–ë–µ–∑ –æ—Ç–∫–∞–∑–∞, –æ—Ç–¥—ã—Ö 30‚Äì60 —Å–µ–∫"},
      {ex:"–û–±—Ä–∞—Ç–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è (–Ω–µ–≥–∞—Ç–∏–≤—ã)", type:"fixed", sets:[r(Math.min(6, Math.ceil(maxPull*0.4))), r(Math.min(6, Math.ceil(maxPull*0.4)))], note:"–°–ø—É—Å–∫ 4‚Äì5 —Å–µ–∫"}
    ]},
    6:{name:"–°–± ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ", blocks:[{ex:"–ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö", type:"note", note:"–•–æ–¥—å–±–∞ 30‚Äì60 –º–∏–Ω, —Ä–∞—Å—Ç—è–∂–∫–∞"}]},
    7:{name:"–í—Å ‚Äî –û—Ç–¥—ã—Ö", blocks:[{ex:"–û—Ç–¥—ã—Ö", type:"note", note:"–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö"}]},
  };
}

/* –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –¥–ª—è –Ω–µ–¥–µ–ª—å 3‚Äì4: +1 –∫ –ø–µ—Ä–≤—ã–º –¥–≤—É–º —Å–µ—Ç–∞–º –≤ —Ç—è–∂—ë–ª—ã–µ –¥–Ω–∏ */
function applyProgression(program, weekOfCycle){
  if(weekOfCycle<=2) return program;
  const add = 1;
  const clone = JSON.parse(JSON.stringify(program));
  // –ü–Ω (1) –∏ –ß—Ç (4) ‚Äî —Ç—è–∂—ë–ª—ã–µ
  [1,4].forEach(d=>{
    const blk = clone[d].blocks.find(b=>b.type==="fixed");
    if(blk && Array.isArray(blk.sets)) {
      blk.sets[0] = (blk.sets[0]||0)+add;
      blk.sets[1] = (blk.sets[1]||0)+add;
    }
  });
  return clone;
}

/* ===== UI / —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
const els = {
  todayChip:document.getElementById('todayChip'),
  wkChip:document.getElementById('wkChip'),
  dayChip:document.getElementById('dayChip'),
  startDate:document.getElementById('startDateInput'),
  prevDay:document.getElementById('prevDay'),
  nextDay:document.getElementById('nextDay'),
  retakeBtn:document.getElementById('retake'),
  toggleTheme:document.getElementById('toggleTheme'),
  resetAll:document.getElementById('resetAll'),
  weekbar:document.getElementById('weekbar'),
  planTitle:document.getElementById('planTitle'),
  planBox:document.getElementById('planBox'),
  saveBtn:document.getElementById('saveBtn'),
  completeBtn:document.getElementById('completeBtn'),
  saveStatus:document.getElementById('saveStatus'),
  tabHistory:document.getElementById('tabHistory'),
  tabChart:document.getElementById('tabChart'),
  historyBody:document.getElementById('historyBody'),
  historyView:document.getElementById('historyView'),
  chartView:document.getElementById('chartView'),
  chart:document.getElementById('chart'),
  // wizard
  wizard:document.getElementById('wizard'),
  maxPull:document.getElementById('maxPull'),
  maxDips:document.getElementById('maxDips'),
  saveWizard:document.getElementById('saveWizard'),
  cancelWizard:document.getElementById('cancelWizard'),
  wizardNote:document.getElementById('wizardNote')
};
let state = {
  selectedKey: fmtDateKey(new Date()),
  program: null
};

/* ===== –¢–µ–º–∞ ===== */
function applyTheme(){ document.body.classList.toggle('light', store.settings.theme==='light'); }
els.toggleTheme.onclick=()=>{ const s=store.settings; s.theme=s.theme==='dark'?'light':'dark'; store.settings=s; applyTheme(); };

/* ===== –ù–µ–¥–µ–ª–∏/–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã ===== */
function weekIndexFrom(startKey, currentKey){ const d=diffDays(startKey,currentKey); return Math.floor(d/7)+1; }
function weekOfCycle(weekIdx){ return mod(weekIdx-1,4)+1; }

/* ===== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ –ª–µ—Ç—É ===== */
function ensureProgram(){
  const s=store.settings;
  if(!s.maxPull || !s.maxDips){
    openWizard("–í–≤–µ–¥–∏ —Ç–µ–∫—É—â–∏–µ –º–∞–∫—Å–∏–º—É–º—ã ‚Äî –ø–æ—Å—Ç—Ä–æ–∏–º –ø—Ä–æ–≥—Ä–∞–º–º—É.");
    return false;
  }
  // –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ state
  const base = buildProgram(s.maxPull, s.maxDips);
  const wIdx = weekIndexFrom(s.startDate, state.selectedKey);
  const wCycle = weekOfCycle(wIdx);
  state.program = applyProgression(base, wCycle);
  // –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ä–µ—Ç–µ—Å—Ç–µ –ø–æ—Å–ª–µ 4 –Ω–µ–¥–µ–ª—å
  if(wIdx>4 && !s.retestPrompted){
    openWizard("–°—Ä–æ–∫ 4 –Ω–µ–¥–µ–ª—å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è. –û–±–Ω–æ–≤–∏–º –º–∞–∫—Å–∏–º—É–º—ã –∏ –Ω–∞—á–Ω—ë–º –Ω–æ–≤—ã–π —Ü–∏–∫–ª?");
    s.retestPrompted=true; store.settings=s;
  }
  return true;
}

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
function renderHeader(){
  const d=parseKey(state.selectedKey);
  const dayNames=["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
  els.todayChip.textContent="–°–µ–≥–æ–¥–Ω—è: "+d.toLocaleDateString();
  els.dayChip.textContent="–î–µ–Ω—å: "+dayNames[isoDay(d)-1];
  const wkIdx=weekIndexFrom(store.settings.startDate, state.selectedKey);
  els.wkChip.textContent="–ù–µ–¥–µ–ª—è —Ü–∏–∫–ª–∞: "+weekOfCycle(wkIdx);
}
function renderWeekbar(){
  const d=parseKey(state.selectedKey), curIso=isoDay(d);
  els.weekbar.innerHTML=""; const labels=["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
  for(let i=1;i<=7;i++){
    const b=document.createElement('button');
    b.className='wbtn'+(i===curIso?' active':''); b.textContent=labels[i-1];
    b.onclick=()=>{ state.selectedKey=fmtDateKey(addDays(d, i-curIso)); renderAll(); };
    els.weekbar.appendChild(b);
  }
}
function renderPlan(){
  if(!ensureProgram()) return;
  const d=parseKey(state.selectedKey); const cfg=state.program[isoDay(d)];
  els.planTitle.textContent="¬∑ "+cfg.name; els.planBox.innerHTML="";
  const stored=getWorkout(state.selectedKey);

  cfg.blocks.forEach((blk, idx)=>{
    const row=document.createElement('div'); row.className='plan-row';
    const left=document.createElement('div'); left.innerHTML=`<div><strong>${blk.ex}</strong></div><div class="sub">${blk.note||""}</div>`;
    const right=document.createElement('div'); right.className='sets';

    if(blk.type==="fixed"){
      blk.sets.forEach((rep, sIdx)=>{
        const s=document.createElement('div'); s.className='set';
        s.innerHTML=`<span class="tag">${rep}x</span>`;
        const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.step='1';
        const val=stored?.blocks?.[idx]?.sets?.[sIdx]; inp.value=(typeof val==='number')?val:'';
        s.appendChild(inp); right.appendChild(s);
      });
    } else if(blk.type==="range"){
      blk.sets.forEach((rng,sIdx)=>{
        const s=document.createElement('div'); s.className='set';
        s.innerHTML=`<span class="tag">${rng[0]}‚Äì${rng[1]}x</span>`;
        const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.step='1';
        const val=stored?.blocks?.[idx]?.sets?.[sIdx]; inp.value=(typeof val==='number')?val:'';
        s.appendChild(inp); right.appendChild(s);
      });
    } else if(blk.type==="ladder"){
      const s=document.createElement('div'); s.className='set';
      s.innerHTML=`<span class="tag">${blk.scheme.join("‚Äì")}</span>`;
      const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.step='1'; inp.placeholder='–∏—Ç–æ–≥–æ';
      const val=stored?.blocks?.[idx]?.total; inp.value=(typeof val==='number')?val:'';
      s.appendChild(inp); right.appendChild(s);
    } else if(blk.type==="time"){
      blk.sets.forEach((t,sIdx)=>{
        const s=document.createElement('div'); s.className='set';
        s.innerHTML=`<span class="tag">${t}</span>`;
        const inp=document.createElement('input'); inp.type='text';
        const val=stored?.blocks?.[idx]?.sets?.[sIdx]; inp.value=(typeof val==='string')?val:'';
        s.appendChild(inp); right.appendChild(s);
      });
    }
    row.appendChild(left); row.appendChild(right); els.planBox.appendChild(row);
  });

  const status=document.createElement('div'); status.className='sub'; status.style.marginTop='8px';
  status.innerHTML="–°—Ç–∞—Ç—É—Å: "+(stored?.done? "‚úÖ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ" : "‚Äî");
  els.planBox.appendChild(status);
}

/* ===== –ò—Å—Ç–æ—Ä–∏—è/–≥—Ä–∞—Ñ–∏–∫ ===== */
function getWorkout(key){return store.workouts[key];}
function setWorkout(key,p){const all=store.workouts;all[key]=p;store.workouts=all;}
function estimateTotals(e){ let s=0;(e.blocks||[]).forEach(b=>{ if(b.type==='ladder') s+=b.total||0; if(b.type==='fixed'||b.type==='range') s+=(b.sets||[]).reduce((a,b)=>a+(+b||0),0); }); return s; }

function renderHistory(){
  const body=els.historyBody; body.innerHTML='';
  const entries=Object.values(store.workouts).sort((a,b)=>a.date.localeCompare(b.date));
  const day=["‚Äî","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
  entries.forEach(e=>{
    const tr=document.createElement('tr');
    const pull=e.totals?.pullups ?? estimateTotals(e);
    const dips=e.totals?.dips ?? 0;
    tr.innerHTML=`
      <td>${parseKey(e.date).toLocaleDateString()}</td>
      <td>${day[e.isoDay||isoDay(parseKey(e.date))]}</td>
      <td>${weekOfCycle(e.weekIndex||1)}</td>
      <td>${pull}</td>
      <td>${dips}</td>
      <td>${e.done?'<span class="pill">‚úÖ</span>':'<span class="pill">‚Äî</span>'}</td>`;
    body.appendChild(tr);
  });
}
function drawChart(){
  const ctx=els.chart.getContext('2d'); const W=els.chart.width,H=els.chart.height;
  ctx.clearRect(0,0,W,H);
  const entries=Object.values(store.workouts).sort((a,b)=>a.date.localeCompare(b.date));
  const labels=entries.map(e=>e.date.slice(5));
  const pull=entries.map(e=>e.totals?.pullups ?? estimateTotals(e));
  const dips=entries.map(e=>e.totals?.dips ?? 0);
  const all=pull.concat(dips); const maxY=Math.max(10,...all);
  const padL=40,padB=28,padR=12,padT=10,plotW=W-padL-padR,plotH=H-padT-padB;
  const border=getComputedStyle(document.body).getPropertyValue('--border').trim();
  const muted=getComputedStyle(document.body).getPropertyValue('--muted').trim();
  const accent=getComputedStyle(document.body).getPropertyValue('--accent').trim();
  const ok=getComputedStyle(document.body).getPropertyValue('--ok').trim();

  ctx.strokeStyle=border; ctx.lineWidth=1; const steps=5;
  for(let i=0;i<=steps;i++){ const y=padT+plotH-(plotH*i/steps);
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    ctx.fillStyle=muted; ctx.font="12px system-ui"; ctx.textAlign="right"; ctx.textBaseline="middle";
    ctx.fillText(String(Math.round(maxY*i/steps)), padL-6, y);
  }
  ctx.fillStyle=muted; ctx.textAlign="center"; ctx.textBaseline="top";
  labels.forEach((lab,i)=>{ const x=padL+(labels.length<=1?plotW/2:(plotW*i/(labels.length-1))); ctx.fillText(lab, x, H-padB+6); });

  function line(arr,color){ ctx.beginPath();
    arr.forEach((v,i)=>{ const x=padL+(labels.length<=1?plotW/2:(plotW*i/(labels.length-1)));
      const y=padT+plotH-(plotH*v/maxY); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle=color; arr.forEach((v,i)=>{ const x=padL+(labels.length<=1?plotW/2:(plotW*i/(labels.length-1)));
      const y=padT+plotH-(plotH*v/maxY); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
  }
  line(pull,accent); line(dips,ok);
}

/* ===== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===== */
function collectAndSave(markDone=false){
  if(!ensureProgram()) return;
  const dKey=state.selectedKey, day=isoDay(parseKey(dKey)), cfg=state.program[day];
  const payload={ date:dKey, isoDay:day, weekIndex:weekIndexFrom(store.settings.startDate,dKey),
    blocks:[], totals:{pullups:0,dips:0}, done: markDone ? true : (getWorkout(dKey)?.done||false) };

  let idx=0;
  document.querySelectorAll('#planBox .plan-row').forEach(row=>{
    if(idx>=cfg.blocks.length) return;
    const blk=cfg.blocks[idx++]; const inputs=row.querySelectorAll('input');
    if(blk.type==='ladder'){
      const tot=parseInt(inputs[0]?.value||'0',10)||0;
      payload.blocks.push({type:'ladder', total:tot});
      if(/–ø–æ–¥—Ç—è–≥/i.test(blk.ex)) payload.totals.pullups+=tot;
      if(/–±—Ä—É—Å—å/i.test(blk.ex)) payload.totals.dips+=tot;
    } else if(blk.type==='fixed'||blk.type==='range'){
      const sets=[]; inputs.forEach(inp=>sets.push(parseInt(inp.value||'0',10)||0));
      payload.blocks.push({type:blk.type, sets}); const sum=sets.reduce((a,b)=>a+b,0);
      if(/–ø–æ–¥—Ç—è–≥/i.test(blk.ex)) payload.totals.pullups+=sum;
      if(/–±—Ä—É—Å—å/i.test(blk.ex)) payload.totals.dips+=sum;
    } else if(blk.type==='time'){ const sets=[]; inputs.forEach(inp=>sets.push(inp.value||'')); payload.blocks.push({type:'time', sets}); }
    else { payload.blocks.push({type:'note'}); }
  });

  setWorkout(dKey,payload);
  els.saveStatus.textContent="–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Ä¢ "+new Date().toLocaleTimeString();
  renderHistory(); if(!els.chartView.classList.contains('hidden')) drawChart(); renderPlan();
}

/* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –≤–∫–ª–∞–¥–∫–∏ ===== */
document.getElementById('prevDay').onclick=()=>{ state.selectedKey=fmtDateKey(addDays(parseKey(state.selectedKey),-1)); renderAll(); };
document.getElementById('nextDay').onclick=()=>{ state.selectedKey=fmtDateKey(addDays(parseKey(state.selectedKey), 1)); renderAll(); };
els.saveBtn.onclick=()=>collectAndSave(false);
els.completeBtn.onclick=()=>collectAndSave(true);
els.startDate.onchange=()=>{ const s=store.settings; s.startDate=els.startDate.value||nextMonday(); s.retestPrompted=false; store.settings=s; renderAll(); };
els.resetAll.onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?')){
  localStorage.removeItem('st_workouts'); const s=store.settings; s.startDate=nextMonday(); s.retestPrompted=false; store.settings=s; renderAll(); }};

els.tabHistory.onclick=()=>{ els.historyView.classList.remove('hidden'); els.chartView.classList.add('hidden');
  els.tabHistory.classList.add('primary'); els.tabChart.classList.remove('primary'); };
els.tabChart.onclick=()=>{ els.historyView.classList.add('hidden'); els.chartView.classList.remove('hidden');
  els.tabChart.classList.add('primary'); els.tabHistory.classList.remove('primary'); drawChart(); };

/* ===== –ú–æ–¥–∞–ª–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤/—Ä–µ—Ç–µ—Å—Ç–∞ ===== */
function openWizard(msg){ els.wizard.classList.remove('hidden'); els.wizardNote.textContent=msg||''; els.maxPull.value=store.settings.maxPull||''; els.maxDips.value=store.settings.maxDips||''; }
function closeWizard(){ els.wizard.classList.add('hidden'); }
els.retakeBtn.onclick=()=>openWizard("–û–±–Ω–æ–≤–∏ –º–∞–∫—Å–∏–º—É–º—ã ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è.");
els.cancelWizard.onclick=()=>closeWizard();
els.saveWizard.onclick=()=>{
  const p=parseInt(els.maxPull.value,10), d=parseInt(els.maxDips.value,10);
  if(!p||!d||p<1||d<1){ els.wizardNote.textContent="–í–≤–µ–¥–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞."; return; }
  const s=store.settings; s.maxPull=p; s.maxDips=d; s.retestPrompted=false; store.settings=s;
  // –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å
  closeWizard(); renderAll();
};

/* ===== –†–µ–Ω–¥–µ—Ä –≤—Å–µ–≥–æ ===== */
function renderAll(){
  applyTheme();
  els.startDate.value=store.settings.startDate;
  if(!ensureProgram()) return; // –ø–æ–∫–∞–∂–µ—Ç –º–∞—Å—Ç–µ—Ä, –µ—Å–ª–∏ –Ω–µ—Ç –º–∞–∫—Å–∏–º—É–º–æ–≤
  renderHeader(); renderWeekbar(); renderPlan(); renderHistory(); if(!els.chartView.classList.contains('hidden')) drawChart();
}

/* ===== init ===== */
(function(){
  applyTheme();
  state.selectedKey=fmtDateKey(new Date());
  renderAll();
  // PWA
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js').catch(console.error)); }
})();
</script>
</body>
</html>
