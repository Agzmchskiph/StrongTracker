<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Турник и Брусья — трекер</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #a8b3c5;
      --txt: #e8eef7;
      --accent: #60a5fa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --border: #1d2a3e;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
      background: #0b1220;
      color: var(--txt)
    }

    header {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      background: #0f172a;
      font-weight: 700;
      letter-spacing: .2px
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px
    }

    section {
      margin-bottom: 20px
    }

    h2 {
      margin: 0 0 10px
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px
    }

    .col {
      flex: 1 1 320px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px
    }

    .btn {
      background: #122038;
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer
    }

    .btn:hover {
      border-color: #2a4166
    }

    .btn.primary {
      background: var(--accent);
      color: #061021;
      font-weight: 700
    }

    select,
    input[type="date"] {
      background: #122038;
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 8px 12px;
      border-radius: 10px
    }

    .list {
      display: grid;
      gap: 8px
    }

    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0e1a31
    }

    .note {
      color: var(--muted);
      font-size: 13px
    }

    .success {
      color: var(--ok)
    }

    .pill {
      position: fixed;
      right: 16px;
      top: 12px;
      background: #0e1a31;
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 13px
    }

    /* Модалка */
    .overlay.hidden {
      display: none
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 7, 18, .7);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1000
    }

    .modal {
      width: min(520px, 100%);
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px
    }

    .field {
      display: grid;
      grid-template-columns: 1fr 140px;
      gap: 12px;
      align-items: center;
      margin: 6px 0
    }

    .field input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0e1a31;
      color: var(--txt);
      font-size: 16px
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px
    }

    .kbd {
      border: 1px solid var(--border);
      border-bottom-width: 2px;
      border-radius: 8px;
      padding: 2px 8px;
      color: var(--muted);
      font-size: 12px
    }
  </style>
</head>

<body>
  <header>Турник и Брусья — 4-недельная программа</header>
  <div class="pill"><span id="saveStatus">Готово</span></div>

  <!-- Модалка -->
  <div class="overlay hidden" id="wizard">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wizTitle">
      <h3 id="wizTitle">Максимальные повторы</h3>
      <p class="note" id="wizardNote">Введи текущие максимумы — подтягивания и брусья.</p>
      <div class="field">
        <label for="maxPull">Подтягивания, раз</label>
        <input id="maxPull" inputmode="numeric" placeholder="например, 15" />
      </div>
      <div class="field">
        <label for="maxDips">Брусья, раз</label>
        <input id="maxDips" inputmode="numeric" placeholder="например, 25" />
      </div>
      <div class="note" style="margin:6px 0">
        <span class="kbd">Enter</span> — сохранить · <span class="kbd">Esc</span> — закрыть
      </div>
      <div class="actions">
        <button class="btn" id="cancelWizard" type="button">Отмена</button>
        <button class="btn primary" id="saveWizard" type="button" disabled>Сохранить</button>
      </div>
    </div>
  </div>

  <main>
    <section class="row">
      <div class="col">
        <div class="card">
          <h2>Период цикла</h2>
          <div class="controls">
            <label class="badge">Старт цикла: <input id="startDate" type="date" /></label>
            <span class="badge">Текущая дата: <b id="currentDateLabel"></b></span>
          </div>
          <p class="note">Старт по умолчанию — ближайший понедельник. Меняй при необходимости.</p>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h2>Неделя</h2>
          <div class="controls">
            <button class="btn" id="prevWeek">← Пред.</button>
            <span class="badge">Неделя цикла: <b id="weekOfCycle">1/4</b></span>
            <button class="btn" id="nextWeek">След. →</button>
          </div>
          <p class="note">Программа на 4 недели. На 5-й неделе — тест максимумов.</p>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h2>День</h2>
          <div class="controls">
            <select id="daySelect">
              <option value="1">Понедельник</option>
              <option value="2">Вторник</option>
              <option value="3">Среда</option>
              <option value="4">Четверг</option>
              <option value="5">Пятница</option>
              <option value="6">Суббота</option>
              <option value="0">Воскресенье</option>
            </select>
            <button class="btn" id="editMaxes">Изменить максимумы</button>
          </div>
          <p class="note">Пн/Ср/Пт — подтягивания · Вт/Чт — брусья · Сб/Вс — отдых.</p>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="col">
        <div class="card">
          <h2>Тренировка на сегодня</h2>
          <div id="workoutList" class="list"></div>
          <div class="controls" style="margin-top:8px">
            <button class="btn primary" id="completeDay">Отметить как выполнено</button>
          </div>
          <p class="note" id="todayNote"></p>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h2>История и заметки</h2>
          <div id="historyList" class="list"></div>
          <div class="controls" style="margin-top:8px">
            <button class="btn" id="clearHistory">Очистить историю</button>
          </div>
          <p class="note">История хранится локально в твоём браузере.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Утилиты даты
    const fmtDateKey = d => { const dt = (d instanceof Date) ? d : new Date(d); const y = dt.getFullYear(), m = String(dt.getMonth() + 1).padStart(2, '0'), day = String(dt.getDate()).padStart(2, '0'); return `${y}-${m}-${day}`; };
    const nextMonday = (from = new Date()) => { const d = new Date(from); const day = d.getDay(); const delta = (8 - (day || 7)); d.setDate(d.getDate() + delta - 1); d.setHours(0, 0, 0, 0); return fmtDateKey(d); };
    const addDays = (dateKey, n) => { const d = new Date(dateKey); d.setDate(d.getDate() + n); return fmtDateKey(d); };
    const isoToHuman = key => new Date(key + 'T00:00:00').toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });

    // ===== Селекторы
    const els = {
      wizard: document.getElementById('wizard'), wizardNote: document.getElementById('wizardNote'),
      maxPull: document.getElementById('maxPull'), maxDips: document.getElementById('maxDips'),
      saveWizard: document.getElementById('saveWizard'), cancelWizard: document.getElementById('cancelWizard'),
      startDate: document.getElementById('startDate'), currentDateLabel: document.getElementById('currentDateLabel'),
      weekOfCycle: document.getElementById('weekOfCycle'), prevWeek: document.getElementById('prevWeek'), nextWeek: document.getElementById('nextWeek'),
      daySelect: document.getElementById('daySelect'),
      workoutList: document.getElementById('workoutList'), historyList: document.getElementById('historyList'),
      todayNote: document.getElementById('todayNote'), completeDay: document.getElementById('completeDay'),
      editMaxes: document.getElementById('editMaxes'), clearHistory: document.getElementById('clearHistory'),
      saveStatus: document.getElementById('saveStatus')
    };

    // ===== Хранилище и состояние
    let state = { selectedKey: fmtDateKey(new Date()), program: null, wizardOpen: false };
    const store = {
      get settings() { const raw = localStorage.getItem('tb_settings'); return raw ? JSON.parse(raw) : { maxPull: null, maxDips: null, startDate: null }; },
      set settings(v) { localStorage.setItem('tb_settings', JSON.stringify(v)); },
      get history() { const raw = localStorage.getItem('tb_history'); return raw ? JSON.parse(raw) : []; },
      set history(v) { localStorage.setItem('tb_history', JSON.stringify(v)); }
    };

    // ===== Модалка (исправлено)
    function openWizard(msg) { state.wizardOpen = true; els.wizard.classList.remove('hidden'); els.wizardNote.textContent = msg || 'Введи текущие максимумы.'; const s = store.settings; els.maxPull.value = s.maxPull ?? ''; els.maxDips.value = s.maxDips ?? ''; validateInputs(); }
    function closeWizard() { state.wizardOpen = false; els.wizard.classList.add('hidden'); }
    const toInt = v => { if (v == null) return NaN; return Math.floor(Number(String(v).replace(',', '.').trim())); };
    function validateInputs() { const p = toInt(els.maxPull.value), d = toInt(els.maxDips.value); const ok = Number.isFinite(p) && Number.isFinite(d) && p > 0 && d > 0; els.saveWizard.disabled = !ok; return ok; }
    ['input', 'change'].forEach(ev => { els.maxPull.addEventListener(ev, validateInputs); els.maxDips.addEventListener(ev, validateInputs); });
    [els.maxPull, els.maxDips].forEach(inp => { inp.addEventListener('keydown', e => { if (e.key === 'Enter' && !els.saveWizard.disabled) els.saveWizard.click(); }); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && !els.wizard.classList.contains('hidden')) closeWizard(); });
    els.wizard.addEventListener('click', e => { if (e.target === els.wizard) closeWizard(); });
    els.cancelWizard.addEventListener('click', () => closeWizard());
    els.saveWizard.onclick = () => { try { const p = toInt(els.maxPull.value), d = toInt(els.maxDips.value); if (!Number.isFinite(p) || !Number.isFinite(d) || p < 1 || d < 1) { els.wizardNote.textContent = 'Введи положительные целые числа.'; return; } const s = store.settings; s.maxPull = p; s.maxDips = d; if (!s.startDate) s.startDate = nextMonday(); store.settings = s; closeWizard(); els.wizard.style.display = 'none'; setTimeout(() => { els.wizard.style.display = ''; }, 0); renderAll(); els.saveStatus.textContent = `Сохранено: подтягивания ${p}, брусья ${d}`; } catch (err) { console.error(err); els.wizardNote.textContent = 'Что-то пошло не так.'; } };

    // ===== Неделя/день
    function weekIndexFrom(startDateKey, currentKey) { const s = new Date(startDateKey + 'T00:00:00'); const c = new Date(currentKey + 'T00:00:00'); const diff = Math.floor((c - s) / 86400000); return Math.max(0, Math.floor(diff / 7)); }
    function weekHuman4(idx) { return Math.min(4, (idx % 4) + 1); } // 1..4

    // ===== План на 4 недели + неделя теста
    function buildDayPlan(week, day, maxPull, maxDips) {
      const name = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][day];
      if (day === 0 || day === 6) return { title: `${name} · Отдых`, rows: [['Отдых / восстановление', 'Прогулка 20–40 мин, растяжка, сон 7–9 ч']] };

      const round = x => Math.max(1, Math.round(x));
      const topPullW1 = round(maxPull * 0.87);            // ≈ 13 при 15
      const topPullW4 = Math.max(topPullW1, round(maxPull * 0.93));
      const topDips = round(maxDips * 0.90);

      // Неделя 5 — тесты
      if (week === 5) {
        if (day === 1) return { title: `${name} · Тест подтягиваний`, rows: [['Тест', 'Подтягивания на максимум (1 подход). Запиши результат.']] };
        if (day === 2) return { title: `${name} · Тест брусьев`, rows: [['Тест', 'Брусья на максимум (1 подход). Запиши результат.']] };
        return { title: `${name} · Восстановление`, rows: [['Лёгкая активность', 'Ходьба/мобилити 15–30 мин']] };
      }

      if (week === 1) {
        if (day === 1) return { title: 'Пн · Подтягивания (интенсивность)', rows: [['Топ-сет', `≈ ${topPullW1} повт. (RIR 1–2)`], ['Объём', '4×8']] };
        if (day === 2) return { title: 'Вт · Брусья (интенсивность)', rows: [['Топ-сет', `≈ ${topDips} повт. (RIR 1–2)`], ['Объём', '4×12']] };
        if (day === 3) return { title: 'Ср · Подтягивания (лёгкий объём)', rows: [['Объём', '6×6']] };
        if (day === 4) return { title: 'Чт · Брусья (лёгкий объём)', rows: [['Объём', '5×10']] };
        if (day === 5) return { title: 'Пт · Лесенка', rows: [['Схема', '1–2–3–4–5 × 2 круга (подтягивания и брусья)']] };
      }
      if (week === 2) {
        if (day === 1) return { title: 'Пн · Подтягивания (интенсивность)', rows: [['Топ-сет', `≈ ${topPullW1} повт. (RIR 1–2)`], ['Объём', '4×9']] };
        if (day === 2) return { title: 'Вт · Брусья (интенсивность)', rows: [['Топ-сет', `≈ ${topDips} повт. (RIR 1–2)`], ['Объём', '4×12']] };
        if (day === 3) return { title: 'Ср · Подтягивания (лёгкий объём)', rows: [['Объём', '6×6 (или 5×7)']] };
        if (day === 4) return { title: 'Чт · Брусья (лёгкий объём)', rows: [['Объём', '5×10 (или 6×8)']] };
        if (day === 5) return { title: 'Пт · Лесенка+', rows: [['Схема', '1–2–3–4–5 × 2 круга + лесенка до «4»']] };
      }
      if (week === 3) {
        if (day === 1) return { title: 'Пн · Подтягивания (интенсивность)', rows: [['Топ-сет', `≈ ${topPullW1} повт. (RIR 1–2)`], ['Объём', '5×8']] };
        if (day === 2) return { title: 'Вт · Брусья (интенсивность)', rows: [['Топ-сет', `≈ ${topDips} повт. (RIR 1–2)`], ['Объём', '5×12']] };
        if (day === 3) return { title: 'Ср · Подтягивания (лёгкий объём)', rows: [['Объём', '6×7 (или 7×6)']] };
        if (day === 4) return { title: 'Чт · Брусья (лёгкий объём)', rows: [['Объём', '6×10']] };
        if (day === 5) return { title: 'Пт · Лесенка ++', rows: [['Схема', '1–2–3–4–5 × 3 круга (или 2,5 круга)']] };
      }
      if (week === 4) {
        if (day === 1) return { title: 'Пн · Подтягивания (интенсивность)', rows: [['Топ-сет', `≈ ${topPullW4} повт. (если есть запас)`], ['Объём', '5×9']] };
        if (day === 2) return { title: 'Вт · Брусья (интенсивность)', rows: [['Топ-сет', `≈ ${topDips} повт. (RIR 1–2)`], ['Объём', '5×13']] };
        if (day === 3) return { title: 'Ср · Подтягивания (лёгкий объём)', rows: [['Объём', '5×8 (или 6×7)']] };
        if (day === 4) return { title: 'Чт · Брусья (лёгкий объём)', rows: [['Объём', '6×11']] };
        if (day === 5) return { title: 'Пт · Лесенка (облегчённая)', rows: [['Схема', '1–2–3–4 × 2 круга (подготовка к тесту)']] };
      }

      return { title: `${name}`, rows: [['План', 'Нет данных']] };
    }

    // ===== Рендер
    function renderWorkout() {
      const s = store.settings;
      if (!s.maxPull || !s.maxDips) { els.workoutList.innerHTML = '<div class="item"><span>Нет данных</span><span class="note">Нажми «Изменить максимумы»</span></div>'; return; }
      if (!s.startDate) { s.startDate = nextMonday(); store.settings = s; }
      const wIdx = weekIndexFrom(s.startDate, state.selectedKey); // 0..N
      const weekHuman = Math.min(5, wIdx + 1); // 1..5
      els.weekOfCycle.textContent = (weekHuman <= 4) ? `${weekHuman}/4` : 'тест';

      const day = new Date(state.selectedKey + 'T00:00:00').getDay(); // 0..6
      const plan = buildDayPlan(weekHuman, day, s.maxPull, s.maxDips);
      state.program = plan;

      if (!plan || !plan.rows || !plan.rows.length) {
        els.workoutList.innerHTML = '<div class="item"><span>Нет плана</span><span class="note">Выбери другой день</span></div>';
      } else {
        els.workoutList.innerHTML = plan.rows.map(([label, val], i) => `
          <div class="item">
            <span>${i === 0 ? '<b>' + plan.title + '</b>' : ''}</span>
            <span>${label}: <b>${val}</b></span>
          </div>
        `).join('');
      }
      els.todayNote.textContent = `Сегодня: ${isoToHuman(state.selectedKey)} · ${['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][day]}`;
    }
    function renderHistory() {
      const hist = store.history.slice().reverse();
      if (!hist.length) { els.historyList.innerHTML = '<div class="item"><span>Пусто</span><span class="note">Здесь появятся выполненные тренировки</span></div>'; return; }
      els.historyList.innerHTML = hist.map(h => `
        <div class="item">
          <span>${isoToHuman(h.date)} · ${h.title}</span>
          <span class="success">${h.detail}</span>
        </div>
      `).join('');
    }
    function renderHeader() { els.currentDateLabel.textContent = isoToHuman(fmtDateKey(new Date())); els.startDate.value = store.settings.startDate || ''; }
    function renderAll() { renderHeader(); renderWorkout(); renderHistory(); }

    // ===== Контролы
    els.prevWeek.addEventListener('click', () => { state.selectedKey = addDays(state.selectedKey, -7); renderAll(); });
    els.nextWeek.addEventListener('click', () => { state.selectedKey = addDays(state.selectedKey, 7); renderAll(); });
    els.startDate.addEventListener('change', () => { const s = store.settings; s.startDate = els.startDate.value || null; store.settings = s; renderAll(); });
    els.daySelect.addEventListener('change', () => {
      const today = new Date(); const base = new Date(today); const day = base.getDay(); const diff = (day === 0 ? -6 : 1 - day);
      base.setDate(base.getDate() + diff);
      const targetDelta = Number(els.daySelect.value) - 1;
      const delta = targetDelta >= 0 ? targetDelta : 6;
      state.selectedKey = fmtDateKey(new Date(base.setDate(base.getDate() + delta)));
      renderAll();
    });
    els.completeDay.addEventListener('click', () => {
      const plan = state.program; if (!plan) return;
      const rec = { date: state.selectedKey, title: plan.title || 'Тренировка', detail: plan.rows.map(r => r.join(': ')).join(' · ') };
      const hist = store.history; hist.push(rec); store.history = hist;
      els.saveStatus.textContent = 'Отмечено как выполнено ✓'; renderHistory();
    });
    els.editMaxes.addEventListener('click', () => openWizard('Обнови максимумы для пересчёта программы.'));
    els.clearHistory.addEventListener('click', () => { if (confirm('Очистить всю историю?')) { store.history = []; renderHistory(); } });

    // ===== Инициализация
    (function init() {
      state.selectedKey = fmtDateKey(new Date());
      const s = store.settings; if (!s.startDate) { s.startDate = nextMonday(); store.settings = s; }
      renderAll();
      if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(console.warn); }
    })();
  </script>
</body>

</html>
